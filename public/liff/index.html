<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Astral Compass - æ˜Ÿã®ç¾…é‡ç›¤</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Helvetica Neue', 'Hiragino Sans', 'Arial', sans-serif;
            background: #f5f3f9;
            color: #333;
        }
        .container {
            max-width: 420px;
            margin: 0 auto;
            background: white;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }
        .chat-box {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        .msg {
            padding: 12px 16px;
            border-radius: 12px;
            max-width: 85%;
            line-height: 1.6;
            font-size: 14px;
        }
        .msg.bot {
            align-self: flex-start;
            background: #e8dff5;
            color: #333;
        }
        .msg.user {
            align-self: flex-end;
            background: #8b6cc7;
            color: white;
        }
        .input-area {
            padding: 16px;
            border-top: 1px solid #ddd;
        }
        .input-field {
            margin-bottom: 12px;
        }
        .input-field label {
            display: block;
            font-size: 12px;
            color: #666;
            margin-bottom: 4px;
        }
        .input-field input,
        .input-field textarea,
        .input-field select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 8px;
            font-size: 14px;
        }
        .input-field textarea {
            resize: vertical;
            min-height: 80px;
        }
        .btn-group {
            display: flex;
            gap: 8px;
            margin-bottom: 12px;
            flex-wrap: wrap;
        }
        .btn-toggle {
            padding: 8px 16px;
            border: 1px solid #ccc;
            border-radius: 20px;
            background: white;
            cursor: pointer;
            font-size: 13px;
            transition: all 0.2s;
        }
        .btn-toggle.active {
            background: #8b6cc7;
            color: white;
            border-color: #8b6cc7;
        }
        .btn {
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: 8px;
            background: #8b6cc7;
            color: white;
            font-size: 14px;
            cursor: pointer;
            font-weight: bold;
        }
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .btn:hover:not(:disabled) {
            background: #6b4c9a;
        }
        .btn-secondary {
            background: #ccc;
            margin-top: 8px;
        }
        .btn-secondary:hover {
            background: #aaa;
        }
        .result-section {
            background: #f9f7fc;
            border: 1px solid #e0d4f0;
            border-radius: 12px;
            padding: 16px;
            margin: 12px 0;
        }
        .result-section h3 {
            font-size: 16px;
            color: #8b6cc7;
            margin-bottom: 8px;
            font-weight: bold;
        }
        .result-section p {
            font-size: 14px;
            line-height: 1.8;
            color: #333;
            white-space: pre-wrap;
        }
        .result-image {
            width: 100%;
            border-radius: 8px;
            margin: 10px 0;
        }
        .stone-item {
            background: white;
            border: 1px solid #e0d4f0;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 8px;
        }
        .stone-item .name {
            font-weight: bold;
            color: #8b6cc7;
            font-size: 14px;
            margin-bottom: 4px;
        }
        .stone-item .reason {
            color: #666;
            font-size: 13px;
        }
        .loading {
            text-align: center;
            padding: 40px 0;
        }
        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid #e0d4f0;
            border-top-color: #8b6cc7;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 12px;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <div class="container">
        <div class="chat-box" id="chatBox"></div>
        <div class="input-area" id="inputArea"></div>
    </div>

    <script>
        const API_BASE = '/api';
        let userState = 'mode_select';
        let formData = {};
        let divinationResult = null;
        let selectedMode = null; // 'divination' or 'stone_select'

        // ===== ã‚ã„ã•ã¤ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ =====
        function getGreetingMessage() {
            const hour = new Date().getHours();
            if (hour >= 5 && hour < 11) {
                return "ãŠã¯ã‚ˆã†ã”ã–ã„ã¾ã™ã€‚Astral Compass - æ˜Ÿã®ç¾…é‡ç›¤ã§ã™ã€‚ã‚ãªãŸã®æ‚©ã¿ã‚„ä¸å®‰ã€ãã—ã¦å¶ãˆãŸã„å¤¢ã‚’èã‹ã›ã¦ãã ã•ã„ã€‚ã´ã£ãŸã‚Šã®çŸ³ã®é­”æ³•ã§ã€ä»Šæ—¥ä¸€æ—¥ãŒè»½ã‚„ã‹ã«ãªã‚‹ã‚ˆã†ã«å°ãã¾ã™ã€‚ã¾ãšã€ã‚ãªãŸã«ã¤ã„ã¦å°‘ã—æ•™ãˆã¦ãã ã•ã„ã­ã€‚";
            } else if (hour >= 11 && hour < 17) {
                return "ã“ã‚“ã«ã¡ã¯ã€‚Astral Compass - æ˜Ÿã®ç¾…é‡ç›¤ã§ã™ã€‚ãµã¨ç«‹ã¡æ­¢ã¾ã‚ŠãŸããªã‚‹æ™‚ã‚„ã€ã“ã‚Œã‹ã‚‰è¸ã¿å‡ºã—ãŸã„ä¸€æ­©ãŒã‚ã‚‹æ™‚ã«ã€ã“ã®å ´æ‰€ãŒã‚ãªãŸã®ã‚³ãƒ³ãƒ‘ã‚¹ã«ãªã‚Šã¾ã™ã€‚ã‚ãªãŸã®æ‚©ã¿ã‚„ä¸å®‰ã€å¤¢ã‚’èã„ã¦ã€ã´ã£ãŸã‚Šã®çŸ³ã®é­”æ³•ã§ãã£ã¨èƒŒä¸­ã‚’æŠ¼ã—ã¾ã™ã€‚ã„ãã¤ã‹ã€ã‚ãªãŸã®ã“ã¨ã‚’æ•™ãˆã¦ãã ã•ã„ã€‚";
            } else if (hour >= 17 && hour < 22) {
                return "ã“ã‚“ã°ã‚“ã¯ã€‚Astral Compass - æ˜Ÿã®ç¾…é‡ç›¤ã§ã™ã€‚ä¸€æ—¥ã®çµ‚ã‚ã‚Šã«ã€å¿ƒã®ä¸­ã‚’é™ã‹ã«æ•´ãˆã¦ã¿ã¾ã›ã‚“ã‹ã€‚æŠ±ãˆã¦ã„ã‚‹æ‚©ã¿ã‚„ä¸å®‰ã€ãã—ã¦å¯†ã‹ã«æ¸©ã‚ã¦ã„ã‚‹å¤¢ã‚’èã„ã¦ã€ã‚ãªãŸã«åˆã†çŸ³ã®é­”æ³•ã§å„ªã—ãå°ãã¾ã™ã€‚ã¾ãšã¯ã€ã‚ãªãŸã«ã¤ã„ã¦ã„ãã¤ã‹ãŠä¼ºã„ã—ã¾ã™ã€‚";
            } else {
                return "é…ãã¾ã§ãŠã¤ã‹ã‚Œã•ã¾ã§ã™ã€‚Astral Compass - æ˜Ÿã®ç¾…é‡ç›¤ã§ã™ã€‚å¤œã ã‹ã‚‰ã“ãé¡”ã‚’å‡ºã™æƒ³ã„ã‚„ä¸å®‰ã‚’ã€ã“ã“ã§ãã£ã¨æ‰“ã¡æ˜ã‘ã¦ãã ã•ã„ã€‚ã‚ãªãŸã®å¿ƒã«å¯„ã‚Šæ·»ã†çŸ³ã®é­”æ³•ã‚’é¸ã‚“ã§ã€é™ã‹ãªå¤œã®ä¸­ã§é€²ã‚€æ–¹å‘ã‚’ä¸€ç·’ã«è¦‹ã¤ã‘ã¦ã„ãã¾ã™ã€‚ã„ãã¤ã‹ã€ã‚ãªãŸã«ã¤ã„ã¦æ•™ãˆã¦ãã ã•ã„ã€‚";
            }
        }

        // ===== ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ =====
        function addMsg(text, isUser = false) {
            const box = document.getElementById('chatBox');
            const div = document.createElement('div');
            div.className = `msg ${isUser ? 'user' : 'bot'}`;
            div.innerHTML = formatText(text);
            box.appendChild(div);
            box.scrollTop = box.scrollHeight;
        }

        function formatText(text) {
            // **text** ã‚’ <strong>text</strong> ã«å¤‰æ›
            return text.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
        }

        function setInputArea(html) {
            document.getElementById('inputArea').innerHTML = html;
        }

        function clearInputArea() {
            setInputArea('');
        }

        // ===== ãƒ¢ãƒ¼ãƒ‰é¸æŠï¼ˆæœ€åˆã®2æŠï¼‰ =====
        function stepModeSelect() {
            userState = 'mode_select';
            addMsg('ã©ã¡ã‚‰ã®æ–¹æ³•ã§çŸ³ã‚’é¸ã³ã¾ã™ã‹ï¼Ÿ', false);
            setInputArea(`
                <button class="btn" onclick="selectMode('divination')">âœ¨ çŸ³ã®é­”æ³•ã®å°ãã‚’å¾—ã‚‹ï¼ˆå ã„ï¼‰</button>
                <button class="btn btn-secondary" onclick="selectMode('stone_select')">ğŸ’ å¥½ã¿ã®çŸ³ã‹ã‚‰é­”æ³•ã‚’å¾—ã‚‹</button>
            `);
        }

        function selectMode(mode) {
            selectedMode = mode;
            if (mode === 'divination') {
                addMsg('çŸ³ã®é­”æ³•ã®å°ãã‚’å¾—ã‚‹', true);
                stepGender();
            } else {
                addMsg('å¥½ã¿ã®çŸ³ã‹ã‚‰é­”æ³•ã‚’å¾—ã‚‹', true);
                stepStoneSelectMethod();
            }
        }

        // ===== çŸ³é¸æŠãƒ•ãƒ­ãƒ¼ =====
        function stepStoneSelectMethod() {
            addMsg('ã©ã®æ–¹æ³•ã§çŸ³ã‚’é¸ã³ã¾ã™ã‹ï¼Ÿ', false);
            setInputArea(`
                <div class="btn-group">
                    <button class="btn-toggle active" onclick="selectStoneMethod('color', this)">è‰²</button>
                    <button class="btn-toggle" onclick="selectStoneMethod('effect', this)">åŠ¹æœ</button>
                    <button class="btn-toggle" onclick="selectStoneMethod('zodiac', this)">æ˜Ÿåº§</button>
                    <button class="btn-toggle" onclick="selectStoneMethod('moon', this)">æœˆ</button>
                </div>
                <button class="btn" onclick="showStoneOptions()">æ¬¡ã¸</button>
            `);
        }

        function selectStoneMethod(method, el) {
            formData.stone_method = method;
            document.querySelectorAll('.btn-toggle').forEach(b => b.classList.remove('active'));
            el.classList.add('active');
        }

        function showStoneOptions() {
            const method = formData.stone_method || 'color';
            addMsg(method, true);
            
            let options = [];
            if (method === 'color') {
                options = ['ç´«', 'ãƒ”ãƒ³ã‚¯', 'é»„', 'é€æ˜', 'é»’', 'æ°´è‰²', 'ç´º', 'èŒ¶é‡‘', 'ç™½', 'èµ¤'];
            } else if (method === 'effect') {
                options = ['æ„›æƒ…', 'ç™’ã—', 'é‡‘é‹', 'æµ„åŒ–', 'ä¿è­·', 'ç›´æ„Ÿ', 'æƒ…ç†±', 'å¥³æ€§æ€§'];
            } else if (method === 'zodiac') {
                options = ['ç‰¡ç¾Šåº§', 'ç‰¡ç‰›åº§', 'åŒå­åº§', 'èŸ¹åº§', 'ç…å­åº§', 'ä¹™å¥³åº§', 'å¤©ç§¤åº§', 'è åº§', 'å°„æ‰‹åº§', 'å±±ç¾Šåº§', 'æ°´ç“¶åº§', 'é­šåº§'];
            } else {
                options = ['1æœˆ', '2æœˆ', '3æœˆ', '4æœˆ', '5æœˆ', '6æœˆ', '7æœˆ', '8æœˆ', '9æœˆ', '10æœˆ', '11æœˆ', '12æœˆ'];
            }

            addMsg(`${method}ã‚’é¸ã‚“ã§ãã ã•ã„`, false);
            let html = '<div class="btn-group">';
            options.forEach(opt => {
                html += `<button class="btn-toggle" onclick="selectStoneOption('${opt}', this)">${opt}</button>`;
            });
            html += '</div><button class="btn" onclick="confirmStoneSelection()">ã“ã®çŸ³ã§é€²ã‚€</button>';
            setInputArea(html);
        }

        function selectStoneOption(option, el) {
            formData.stone_option = option;
            document.querySelectorAll('.btn-toggle').forEach(b => b.classList.remove('active'));
            el.classList.add('active');
        }

        function confirmStoneSelection() {
            const option = formData.stone_option;
            if (!option) {
                addMsg('é¸æŠã—ã¦ãã ã•ã„', false);
                return;
            }
            addMsg(option, true);
            
            // çŸ³å€™è£œã‚’ä½œã‚‹ï¼ˆç°¡æ˜“ç‰ˆï¼‰
            const stoneMap = {
                'ç´«': 'ã‚¢ãƒ¡ã‚¸ã‚¹ãƒˆ', 'ãƒ”ãƒ³ã‚¯': 'ãƒ­ãƒ¼ã‚ºã‚¯ã‚©ãƒ¼ãƒ„', 'é»„': 'ã‚·ãƒˆãƒªãƒ³', 'é€æ˜': 'æ°´æ™¶',
                'é»’': 'ã‚ªãƒ‹ã‚­ã‚¹', 'æ°´è‰²': 'ã‚¢ã‚¯ã‚¢ãƒãƒªãƒ³', 'ç´º': 'ãƒ©ãƒ”ã‚¹ãƒ©ã‚ºãƒª', 'èŒ¶é‡‘': 'ã‚¿ã‚¤ã‚¬ãƒ¼ã‚¢ã‚¤',
                'ç™½': 'ãƒ ãƒ¼ãƒ³ã‚¹ãƒˆãƒ¼ãƒ³', 'èµ¤': 'ã‚«ãƒ¼ãƒãƒªã‚¢ãƒ³'
            };
            const selectedStone = stoneMap[option] || 'ã‚¢ãƒ¡ã‚¸ã‚¹ãƒˆ';
            
            divinationResult = {
                stones_for_user: [
                    { name: selectedStone, reason: `${option}ã‚’é¸ã‚“ã ã‚ãªãŸã«ã´ã£ãŸã‚Šã®çŸ³ã§ã™` }
                ]
            };
            
            stepBraceletSize();
        }

        // ===== ã‚¹ãƒ†ãƒƒãƒ—: æ€§åˆ¥ =====
        function stepGender() {
            userState = 'gender';
            setInputArea(`
                <div class="btn-group">
                    <button class="btn-toggle active" onclick="selectGender('å¥³æ€§', this)">å¥³æ€§</button>
                    <button class="btn-toggle" onclick="selectGender('ç”·æ€§', this)">ç”·æ€§</button>
                    <button class="btn-toggle" onclick="selectGender('ãã®ä»–', this)">ãã®ä»–</button>
                </div>
                <button class="btn" onclick="nextStep()">æ¬¡ã¸</button>
            `);
        }

        function selectGender(gender, el) {
            formData.gender = gender;
            document.querySelectorAll('.btn-toggle').forEach(b => b.classList.remove('active'));
            el.classList.add('active');
        }

        // ===== ã‚¹ãƒ†ãƒƒãƒ—: æ‚©ã¿ã‚«ãƒ†ã‚´ãƒª =====
        function stepConcerns() {
            if (!formData.gender) return;
            addMsg(formData.gender, true);
            addMsg('æ°—ã«ãªã£ã¦ã„ã‚‹ã“ã¨ã¯ã‚ã‚Šã¾ã™ã‹ï¼Ÿï¼ˆè¤‡æ•°é¸æŠå¯ï¼‰', false);

            userState = 'concerns';
            setInputArea(`
                <div class="btn-group">
                    <button class="btn-toggle" onclick="toggleConcern(this, 'æ‹æ„›')">ğŸ’• æ‹æ„›</button>
                    <button class="btn-toggle" onclick="toggleConcern(this, 'ä»•äº‹')">ğŸ’¼ ä»•äº‹</button>
                    <button class="btn-toggle" onclick="toggleConcern(this, 'é‡‘é‹')">ğŸ’° é‡‘é‹</button>
                    <button class="btn-toggle" onclick="toggleConcern(this, 'å¥åº·')">ğŸŒ¿ å¥åº·</button>
                    <button class="btn-toggle" onclick="toggleConcern(this, 'äººé–“é–¢ä¿‚')">ğŸ¤ äººé–“é–¢ä¿‚</button>
                    <button class="btn-toggle" onclick="toggleConcern(this, 'ãã®ä»–')">âœ¨ ãã®ä»–</button>
                </div>
                <button class="btn" onclick="nextStep()">æ¬¡ã¸</button>
            `);
        }

        function toggleConcern(el, concern) {
            formData.concerns = formData.concerns || [];
            if (el.classList.contains('active')) {
                el.classList.remove('active');
                formData.concerns = formData.concerns.filter(c => c !== concern);
            } else {
                el.classList.add('active');
                if (!formData.concerns.includes(concern)) {
                    formData.concerns.push(concern);
                }
            }
        }

        // ===== ã‚¹ãƒ†ãƒƒãƒ—: å…·ä½“çš„ãªæ‚©ã¿ =====
        function stepProblem() {
            if (!formData.concerns || formData.concerns.length === 0) {
                addMsg('å°‘ãªãã¨ã‚‚1ã¤é¸ã‚“ã§ãã ã•ã„', false);
                return;
            }
            addMsg(formData.concerns.join('ã€'), true);
            addMsg('å…·ä½“çš„ã«ã©ã‚“ãªã“ã¨ã§ãŠæ‚©ã¿ã§ã™ã‹ï¼Ÿï¼ˆè¨˜è¿°å¼ï¼‰', false);

            userState = 'problem';
            setInputArea(`
                <div class="input-field">
                    <textarea id="problemText" placeholder="ä¾‹ï¼šæœ€è¿‘å½¼ã¨ã®é–¢ä¿‚ãŒã†ã¾ãã„ã‹ãªãã¦..."></textarea>
                </div>
                <button class="btn" onclick="nextStep()">æ¬¡ã¸</button>
            `);
        }

        // ===== ã‚¹ãƒ†ãƒƒãƒ—: ç”Ÿå¹´æœˆæ—¥ =====
        function stepBirth() {
            const problem = document.getElementById('problemText')?.value || '';
            formData.problem = problem;
            addMsg(problem || 'ï¼ˆè¨˜è¿°ãªã—ï¼‰', true);
            addMsg('è¥¿æ´‹å æ˜Ÿè¡“ã«å¿…è¦ãªæƒ…å ±ã‚’ãŠèãã—ã¾ã™ã€‚', false);

            userState = 'birth';
            setInputArea(`
                <div class="input-field">
                    <label>ç”Ÿå¹´æœˆæ—¥ *</label>
                    <input type="date" id="birthDate" required>
                </div>
                <div class="input-field">
                    <label>å‡ºç”Ÿæ™‚é–“</label>
                    <input type="time" id="birthTime">
                </div>
                <div class="input-field">
                    <label>å‡ºç”Ÿåœ°</label>
                    <input type="text" id="birthPlace" placeholder="ä¾‹ï¼šæœ­å¹Œå¸‚">
                </div>
                <button class="btn" onclick="nextStep()">å ã„é–‹å§‹</button>
            `);
        }

        // ===== å ã„å®Ÿè¡Œ =====
        async function executeDiagnose() {
            const date = document.getElementById('birthDate')?.value;
            const time = document.getElementById('birthTime')?.value || '';
            const place = document.getElementById('birthPlace')?.value || '';

            if (!date) {
                addMsg('ç”Ÿå¹´æœˆæ—¥ã¯å¿…é ˆã§ã™', false);
                return;
            }

            formData.birth = { date, time, place };
            addMsg(`${date} (${time || 'æ™‚é–“ä¸æ˜'}) å‡ºç”Ÿåœ°:${place || 'ä¸æ˜'}`, true);

            setInputArea(`
                <div class="loading">
                    <div class="spinner"></div>
                    <p>æ˜Ÿã®é…ç½®ã‚’èª­ã¿è§£ã„ã¦ã„ã¾ã™... ğŸŒŒ</p>
                </div>
            `);

            try {
                const res = await fetch(`${API_BASE}/diagnose`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(formData)
                });

                const json = await res.json();

                if (json.error) {
                    addMsg(`ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${json.error}`, false);
                    clearInputArea();
                    return;
                }

                divinationResult = json.result;
                window.diagnosisId = json.diagnosis_id;

                displayDivinationResult(json.result);

            } catch (err) {
                addMsg('é€šä¿¡ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ', false);
                clearInputArea();
            }
        }

        // ===== å ã„çµæœè¡¨ç¤º =====
        function displayDivinationResult(result) {
            clearInputArea();

            // ã€ã€‘è¦‹å‡ºã—ã‚’å‰Šé™¤ã—ã¦ã‹ã‚‰è¡¨ç¤º
            const cleanText = (text) => text ? text.replace(/ã€.+?ã€‘/g, '') : '';

            if (result.destiny_map) {
                const section = document.createElement('div');
                section.className = 'result-section';
                section.innerHTML = `<h3>é‹å‘½ã®åœ°å›³</h3><p>${formatText(cleanText(result.destiny_map))}</p>`;
                document.getElementById('chatBox').appendChild(section);
            }

            if (result.past) {
                const section = document.createElement('div');
                section.className = 'result-section';
                section.innerHTML = `<h3>éå»</h3><p>${formatText(cleanText(result.past))}</p>`;
                document.getElementById('chatBox').appendChild(section);
            }

            if (result.present) {
                const section = document.createElement('div');
                section.className = 'result-section';
                section.innerHTML = `<h3>ç¾åœ¨</h3><p>${formatText(cleanText(result.present))}</p>`;
                document.getElementById('chatBox').appendChild(section);
            }

            if (result.future) {
                const section = document.createElement('div');
                section.className = 'result-section';
                section.innerHTML = `<h3>æœªæ¥</h3><p>${formatText(cleanText(result.future))}</p>`;
                document.getElementById('chatBox').appendChild(section);
            }

            if (result.element_diagnosis) {
                const section = document.createElement('div');
                section.className = 'result-section';
                section.innerHTML = `<h3>ã‚¨ãƒ¬ãƒ¡ãƒ³ãƒˆè¨ºæ–­</h3><p>${formatText(cleanText(result.element_diagnosis))}</p>`;
                document.getElementById('chatBox').appendChild(section);
            }

            if (result.oracle_card) {
                const section = document.createElement('div');
                section.className = 'result-section';
                let html = `<h3>ã‚ªãƒ©ã‚¯ãƒ«ã‚«ãƒ¼ãƒ‰</h3><p>${result.oracle_card.name}</p>`;
                if (result.oracle_card.image_url) {
                    const transform = result.oracle_card.is_upright ? '' : 'transform: scaleY(-1);';
                    html += `<img src="${result.oracle_card.image_url}" class="result-image" style="${transform}" onerror="this.style.display='none'">`;
                }
                html += `<p>${formatText(cleanText(result.oracle_message || result.oracle_card.meaning))}</p>`;
                section.innerHTML = html;
                document.getElementById('chatBox').appendChild(section);
            }

            if (result.stones_for_user && result.stones_for_user.length > 0) {
                const section = document.createElement('div');
                section.className = 'result-section';
                let html = `<h3>ğŸ’ ã‚ãªãŸã«ãƒãƒƒãƒã™ã‚‹çŸ³ã¯ã“ã‚Œã§ã™</h3>`;
                if (result.stones_image_url) {
                    html += `<img src="${result.stones_image_url}" class="result-image" onerror="this.style.display='none'">`;
                }
                result.stones_for_user.forEach(stone => {
                    html += `
                        <div class="stone-item">
                            <div class="name">ğŸ’ ${stone.name}</div>
                            <div class="reason">${stone.reason}</div>
                        </div>
                    `;
                });
                section.innerHTML = html;
                document.getElementById('chatBox').appendChild(section);
            }

            if (result.bracelet_proposal) {
                const section = document.createElement('div');
                section.className = 'result-section';
                section.innerHTML = `<h3>çŸ³ã®ææ¡ˆ</h3><p>${formatText(cleanText(result.bracelet_proposal))}</p>`;
                document.getElementById('chatBox').appendChild(section);
            }

            document.getElementById('chatBox').scrollTop = document.getElementById('chatBox').scrollHeight;

            setInputArea(`
                <button class="btn" onclick="stepBraceletSize()">ğŸ’ ãƒ–ãƒ¬ã‚¹ãƒ¬ãƒƒãƒˆè¨­å®šã¸é€²ã‚€</button>
                <button class="btn btn-secondary" onclick="restartFromBeginning()">ğŸ”„ ã‚‚ã†ä¸€åº¦å ã†</button>
            `);
        }

        // ===== ãƒ–ãƒ¬ã‚¹ãƒ¬ãƒƒãƒˆã‚µã‚¤ã‚ºï¼‹ãƒ‡ã‚¶ã‚¤ãƒ³é¸æŠ =====
        function stepBraceletSize() {
            addMsg('ãƒ–ãƒ¬ã‚¹ãƒ¬ãƒƒãƒˆã®ã‚µã‚¤ã‚ºã¨ãƒ‡ã‚¶ã‚¤ãƒ³ã‚’é¸ã‚“ã§ãã ã•ã„ã€‚', false);

            const savedWrist = formData.wrist_inner_cm || 15.0;
            const savedBead = formData.bead_size_mm || 8;

            setInputArea(`
                <div class="input-field">
                    <label>æ‰‹é¦–ã®å†…å¾„ï¼ˆcmï¼‰</label>
                    <input type="number" id="wristInner" step="0.5" value="${savedWrist}" min="10" max="25">
                    <small style="color:#999;">æ‰‹é¦–ã®æœ€ã‚‚ç´°ã„éƒ¨åˆ†ã‚’æ¸¬ã£ã¦ãã ã•ã„</small>
                </div>
                <div class="input-field">
                    <label>çŸ³ã®å¤§ãã•ï¼ˆmmï¼‰</label>
                    <select id="beadSize">
                        <option value="6" ${savedBead == 6 ? 'selected' : ''}>6mmï¼ˆç´°ã‚ã§è¯å¥¢ï¼‰</option>
                        <option value="8" ${savedBead == 8 ? 'selected' : ''}>8mmï¼ˆæ¨™æº–ï¼‰</option>
                        <option value="10" ${savedBead == 10 ? 'selected' : ''}>10mmï¼ˆå¤ªã‚ã§å­˜åœ¨æ„Ÿï¼‰</option>
                        <option value="12" ${savedBead == 12 ? 'selected' : ''}>12mmï¼ˆãƒœãƒªãƒ¥ãƒ¼ãƒ é‡è¦–ï¼‰</option>
                    </select>
                </div>
                <div class="input-field">
                    <label>ãƒ‡ã‚¶ã‚¤ãƒ³ã‚¹ã‚¿ã‚¤ãƒ«</label>
                    <div class="btn-group">
                        <button class="btn-toggle active" onclick="selectDesign('ãŠã¾ã‹ã›', this)">ãŠã¾ã‹ã›</button>
                        <button class="btn-toggle" onclick="selectDesign('å˜è‰²ï¼ˆã‚·ãƒ³ãƒ—ãƒ«ï¼‰', this)">å˜è‰²</button>
                        <button class="btn-toggle" onclick="selectDesign('ï¼’è‰²ï¼ˆæ··åˆï¼‰', this)">ï¼’è‰²</button>
                        <button class="btn-toggle" onclick="selectDesign('ãƒˆãƒƒãƒ—ã‚’å…¥ã‚Œã‚‹', this)">ãƒˆãƒƒãƒ—</button>
                    </div>
                </div>
                <button class="btn" onclick="buildBracelet()">âœ¨ ã‚ãªãŸã‚’å°ããƒ–ãƒ¬ã‚¹ãƒ¬ãƒƒãƒˆã‚’å®Œæˆã•ã›ã‚‹</button>
            `);
        }

        function selectDesign(style, el) {
            formData.design_style = style;
            document.querySelectorAll('.input-field:last-child .btn-toggle').forEach(b => b.classList.remove('active'));
            el.classList.add('active');
        }

        // ===== ãƒ–ãƒ¬ã‚¹ãƒ¬ãƒƒãƒˆç”Ÿæˆ =====
        async function buildBracelet() {
            const wrist = parseFloat(document.getElementById('wristInner')?.value || 15.0);
            const beadSize = parseInt(document.getElementById('beadSize')?.value || 8);
            const designStyle = formData.design_style || 'ãŠã¾ã‹ã›';

            formData.wrist_inner_cm = wrist;
            formData.bead_size_mm = beadSize;

            addMsg(`æ‰‹é¦–å†…å¾„: ${wrist}cm / çŸ³ã‚µã‚¤ã‚º: ${beadSize}mm / ãƒ‡ã‚¶ã‚¤ãƒ³: ${designStyle}`, true);

            setInputArea(`
                <div class="loading">
                    <div class="spinner"></div>
                    <p>ãƒ–ãƒ¬ã‚¹ãƒ¬ãƒƒãƒˆã‚’ãƒ‡ã‚¶ã‚¤ãƒ³ã—ã¦ã„ã¾ã™... ğŸ’</p>
                </div>
            `);

            try {
                const res = await fetch(`${API_BASE}/build-bracelet`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        diagnosis_id: window.diagnosisId,
                        stones_for_user: divinationResult.stones_for_user || [],
                        wrist_inner_cm: wrist,
                        bead_size_mm: beadSize,
                        design_style: designStyle
                    })
                });

                const json = await res.json();

                if (json.error) {
                    addMsg(`ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${json.error}`, false);
                    clearInputArea();
                    return;
                }

                displayBraceletResult(json);

            } catch (err) {
                addMsg('é€šä¿¡ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ', false);
                clearInputArea();
            }
        }

        // ===== ãƒ–ãƒ¬ã‚¹ãƒ¬ãƒƒãƒˆçµæœè¡¨ç¤º =====
        function displayBraceletResult(data) {
            clearInputArea();

            const section = document.createElement('div');
            section.className = 'result-section';
            let html = `<h3>ğŸ’ ã‚ãªãŸã‚’å°ããƒ–ãƒ¬ã‚¹ãƒ¬ãƒƒãƒˆã¯ã“ã‚Œã§ã™</h3>`;

            if (divinationResult.stones_image_url) {
                html += `<img src="${divinationResult.stones_image_url}" class="result-image" onerror="this.style.display='none'">`;
            }

            html += `<p>${formatText(data.design_text || 'ãƒ‡ã‚¶ã‚¤ãƒ³æƒ…å ±ãŒã‚ã‚Šã¾ã›ã‚“')}</p>`;

            section.innerHTML = html;
            document.getElementById('chatBox').appendChild(section);

            if (data.order_summary) {
                const orderSection = document.createElement('div');
                orderSection.className = 'result-section';
                orderSection.innerHTML = `<h3>ğŸ“‹ ã‚ãªãŸã‚’å°ãçŸ³ãŸã¡</h3><p style="font-size:13px;">${data.order_summary.replace(/\n/g, '<br>')}</p>`;
                document.getElementById('chatBox').appendChild(orderSection);
            }

            document.getElementById('chatBox').scrollTop = document.getElementById('chatBox').scrollHeight;

            // ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ï¼‹ã‚µã‚¤ã‚ºä¿å­˜
            const savedProfile = {
                gender: formData.gender,
                birth: formData.birth,
                wrist_inner_cm: formData.wrist_inner_cm,
                bead_size_mm: formData.bead_size_mm
            };
            localStorage.setItem('hoshin-proifle', JSON.stringify(savedProfile));

            setInputArea(`
                <button class="btn" onclick="confirmOrder()">ğŸ“± LINEã§ã‚ªãƒ¼ãƒ€ãƒ¼ã™ã‚‹</button>
                <button class="btn btn-secondary" onclick="restartFromBeginning()">ğŸ”„ ã‚‚ã†ä¸€åº¦å ã†</button>
            `);
        }

        // ===== ã‚ªãƒ¼ãƒ€ãƒ¼ç¢ºèª =====
        function confirmOrder() {
            addMsg('ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ï¼ã‚ªãƒ¼ãƒ€ãƒ¼æƒ…å ±ã‚’é€ä¿¡ã—ã¾ã—ãŸã€‚', false);
            clearInputArea();
            addMsg('ãƒ¡ãƒ¼ãƒ«ã§ç¢ºèªãŒæ¥ã¾ã™ã€‚ãŠå¾…ã¡ãã ã•ã„ âœ¨', false);
        }

        // ===== ã‚‚ã†ä¸€åº¦å ã†ï¼ˆå‰å›æƒ…å ±ä½¿ã†ï¼‰ =====
        function restartFromBeginning() {
            document.getElementById('chatBox').innerHTML = '';
            const greeting = getGreetingMessage();
            document.getElementById('chatBox').innerHTML = `<div class="msg bot">${greeting}</div>`;
            
            const saved = localStorage.getItem('hoshin-proifle');
            if (saved) {
                formData = JSON.parse(saved);
                askReuseProfile();
            } else {
                stepModeSelect();
            }
        }

        // ===== ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«å†åˆ©ç”¨ =====
        function askReuseProfile() {
            const birth = formData.birth || {};
            const summary = [
                `æ€§åˆ¥ï¼š${formData.gender || 'æœªè¨­å®š'}`,
                `ç”Ÿå¹´æœˆæ—¥ï¼š${birth.date || 'æœªè¨­å®š'}`,
                `å‡ºç”Ÿåœ°ï¼š${birth.place || 'æœªè¨­å®š'}`,
                `æ‰‹é¦–å†…å¾„ï¼š${formData.wrist_inner_cm || 15.0}cm`,
                `çŸ³ã‚µã‚¤ã‚ºï¼š${formData.bead_size_mm || 8}mm`
            ].join('\n');

            addMsg('å‰å›ã®ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«æƒ…å ±ã‚’è¦‹ã¤ã‘ã¾ã—ãŸã€‚', false);
            addMsg(summary, false);

            setInputArea(`
                <button class="btn" onclick="reuseProfile()">ã“ã®æƒ…å ±ã‚’ä½¿ã†</button>
                <button class="btn btn-secondary" onclick="resetProfile()">ä¿®æ­£ã—ã¦ã‹ã‚‰å ã†</button>
            `);
        }

        function reuseProfile() {
            selectedMode = 'divination';
            stepConcernsOnly();
        }

        function resetProfile() {
            formData = {};
            document.getElementById('chatBox').innerHTML = `<div class="msg bot">${getGreetingMessage()}</div>`;
            stepModeSelect();
        }

        // ===== 2å›ç›®ä»¥é™: æ‚©ã¿ã ã‘èããƒ•ãƒ­ãƒ¼ =====
        function stepConcernsOnly() {
            userState = 'concerns_only';
            formData.concerns = [];
            addMsg('ä»Šå›ã¯ã€ä»Šã®æ‚©ã¿ã ã‘ã‚’æ•™ãˆã¦ãã ã•ã„ã€‚', false);
            setInputArea(`
                <div class="btn-group">
                    <button class="btn-toggle" onclick="toggleConcern(this, 'æ‹æ„›')">ğŸ’• æ‹æ„›</button>
                    <button class="btn-toggle" onclick="toggleConcern(this, 'ä»•äº‹')">ğŸ’¼ ä»•äº‹</button>
                    <button class="btn-toggle" onclick="toggleConcern(this, 'é‡‘é‹')">ğŸ’° é‡‘é‹</button>
                    <button class="btn-toggle" onclick="toggleConcern(this, 'å¥åº·')">ğŸŒ¿ å¥åº·</button>
                    <button class="btn-toggle" onclick="toggleConcern(this, 'äººé–“é–¢ä¿‚')">ğŸ¤ äººé–“é–¢ä¿‚</button>
                    <button class="btn-toggle" onclick="toggleConcern(this, 'ãã®ä»–')">âœ¨ ãã®ä»–</button>
                </div>
                <button class="btn" onclick="stepProblemOnly()">æ¬¡ã¸</button>
            `);
        }

        function stepProblemOnly() {
            if (!formData.concerns || formData.concerns.length === 0) {
                addMsg('å°‘ãªãã¨ã‚‚1ã¤é¸ã‚“ã§ãã ã•ã„', false);
                return;
            }
            addMsg(formData.concerns.join('ã€'), true);
            addMsg('å…·ä½“çš„ã«ã©ã‚“ãªã“ã¨ã§ãŠæ‚©ã¿ã§ã™ã‹ï¼Ÿï¼ˆè¨˜è¿°å¼ï¼‰', false);

            userState = 'problem_only';
            setInputArea(`
                <div class="input-field">
                    <textarea id="problemText" placeholder="ä¾‹ï¼šæœ€è¿‘å½¼ã¨ã®é–¢ä¿‚ãŒã†ã¾ãã„ã‹ãªãã¦..."></textarea>
                </div>
                <button class="btn" onclick="executeDiagnoseWithSavedProfile()">å ã„é–‹å§‹</button>
            `);
        }

        async function executeDiagnoseWithSavedProfile() {
            const problem = document.getElementById('problemText')?.value || '';
            formData.problem = problem;
            addMsg(problem || 'ï¼ˆè¨˜è¿°ãªã—ï¼‰', true);
            addMsg('å‰å›ã®ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«æƒ…å ±ã‚’ä½¿ã£ã¦å ã„ã‚’è¡Œã„ã¾ã™ã€‚', false);

            setInputArea(`
                <div class="loading">
                    <div class="spinner"></div>
                    <p>æ˜Ÿã®é…ç½®ã‚’èª­ã¿è§£ã„ã¦ã„ã¾ã™... ğŸŒŒ</p>
                </div>
            `);

            try {
                const res = await fetch(`${API_BASE}/diagnose`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(formData)
                });

                const json = await res.json();

                if (json.error) {
                    addMsg(`ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${json.error}`, false);
                    clearInputArea();
                    return;
                }

                divinationResult = json.result;
                window.diagnosisId = json.diagnosis_id;

                displayDivinationResult(json.result);

            } catch (err) {
                addMsg('é€šä¿¡ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ', false);
                clearInputArea();
            }
        }

        // ===== ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ =====
        function nextStep() {
            if (userState === 'gender') stepConcerns();
            else if (userState === 'concerns') stepProblem();
            else if (userState === 'problem') stepBirth();
            else if (userState === 'birth') executeDiagnose();
        }

        // ===== åˆæœŸè¡¨ç¤º =====
        window.onload = function() {
            const saved = localStorage.getItem('hoshin-proifle');
            const box = document.getElementById('chatBox');
            box.innerHTML = `<div class="msg bot">${getGreetingMessage()}</div>`;

            if (saved) {
                formData = JSON.parse(saved);
                askReuseProfile();
            } else {
                stepModeSelect();
            }
        };
    </script>
</body>
</html>