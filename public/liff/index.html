<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ˜Ÿã®ç¾…é‡ç›¤ - å ã„Ã—ãƒ–ãƒ¬ã‚¹ãƒ¬ãƒƒãƒˆ</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Helvetica Neue', 'Hiragino Sans', 'Arial', sans-serif;
            background: #f5f3f9;
            color: #333;
        }
        .container {
            max-width: 420px;
            margin: 0 auto;
            background: white;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }
        .chat-box {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        .msg {
            padding: 12px 16px;
            border-radius: 12px;
            max-width: 85%;
            line-height: 1.6;
            font-size: 14px;
        }
        .msg.bot {
            align-self: flex-start;
            background: #e8dff5;
            color: #333;
        }
        .msg.user {
            align-self: flex-end;
            background: #8b6cc7;
            color: white;
        }
        .input-area {
            padding: 16px;
            border-top: 1px solid #ddd;
        }
        .input-field {
            margin-bottom: 12px;
        }
        .input-field label {
            display: block;
            font-size: 12px;
            color: #666;
            margin-bottom: 4px;
        }
        .input-field input,
        .input-field textarea,
        .input-field select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 8px;
            font-size: 14px;
        }
        .input-field textarea {
            resize: vertical;
            min-height: 80px;
        }
        .btn-group {
            display: flex;
            gap: 8px;
            margin-bottom: 12px;
            flex-wrap: wrap;
        }
        .btn-toggle {
            padding: 8px 16px;
            border: 1px solid #ccc;
            border-radius: 20px;
            background: white;
            cursor: pointer;
            font-size: 13px;
            transition: all 0.2s;
        }
        .btn-toggle.active {
            background: #8b6cc7;
            color: white;
            border-color: #8b6cc7;
        }
        .btn {
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: 8px;
            background: #8b6cc7;
            color: white;
            font-size: 14px;
            cursor: pointer;
            font-weight: bold;
        }
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .btn:hover:not(:disabled) {
            background: #6b4c9a;
        }
        .btn-secondary {
            background: #ccc;
            margin-top: 8px;
        }
        .btn-secondary:hover {
            background: #aaa;
        }
        .result-section {
            background: #f9f7fc;
            border: 1px solid #e0d4f0;
            border-radius: 12px;
            padding: 16px;
            margin: 12px 0;
        }
        .result-section h3 {
            font-size: 16px;
            color: #8b6cc7;
            margin-bottom: 8px;
            font-weight: bold;
        }
        .result-section h4 {
            font-size: 14px;
            color: #764ba2;
            margin-top: 12px;
            margin-bottom: 6px;
            font-weight: bold;
        }
        .result-section p {
            font-size: 14px;
            line-height: 1.8;
            color: #333;
            white-space: pre-wrap;
        }
        .result-image {
            width: 100%;
            border-radius: 8px;
            margin: 10px 0;
        }
        .stone-item {
            background: white;
            border: 1px solid #e0d4f0;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 8px;
        }
        .stone-item .name {
            font-weight: bold;
            color: #8b6cc7;
            font-size: 14px;
            margin-bottom: 4px;
        }
        .stone-item .reason {
            color: #666;
            font-size: 13px;
        }
        .loading {
            text-align: center;
            padding: 40px 0;
        }
        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid #e0d4f0;
            border-top-color: #8b6cc7;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 12px;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <div class="container">
        <div class="chat-box" id="chatBox">
            <div class="msg bot">
                ã“ã‚“ã«ã¡ã¯ âœ¨ ã‚ãªãŸã«ã´ã£ãŸã‚Šã®ãƒ–ãƒ¬ã‚¹ãƒ¬ãƒƒãƒˆã‚’ä½œã‚‹ãŸã‚ã«ã€ã„ãã¤ã‹è³ªå•ã•ã›ã¦ãã ã•ã„ã€‚
            </div>
        </div>
        <div class="input-area" id="inputArea"></div>
    </div>

    <script>
        const API_BASE = '/api';
        let userState = 'gender';
        let formData = {};
        let divinationResult = null;

        // ===== ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ =====
        function addMsg(text, isUser = false) {
            const box = document.getElementById('chatBox');
            const div = document.createElement('div');
            div.className = `msg ${isUser ? 'user' : 'bot'}`;
            div.textContent = text;
            box.appendChild(div);
            box.scrollTop = box.scrollHeight;
        }

        function setInputArea(html) {
            document.getElementById('inputArea').innerHTML = html;
        }

        function clearInputArea() {
            setInputArea('');
        }

        // ===== ã‚¹ãƒ†ãƒƒãƒ—: æ€§åˆ¥ =====
        function stepGender() {
            userState = 'gender';
            setInputArea(`
                <div class="btn-group">
                    <button class="btn-toggle active" onclick="selectGender('å¥³æ€§', this)">å¥³æ€§</button>
                    <button class="btn-toggle" onclick="selectGender('ç”·æ€§', this)">ç”·æ€§</button>
                    <button class="btn-toggle" onclick="selectGender('ãã®ä»–', this)">ãã®ä»–</button>
                </div>
                <button class="btn" onclick="nextStep()">æ¬¡ã¸</button>
            `);
        }

        function selectGender(gender, el) {
            formData.gender = gender;
            document.querySelectorAll('.btn-toggle').forEach(b => b.classList.remove('active'));
            el.classList.add('active');
        }

        // ===== ã‚¹ãƒ†ãƒƒãƒ—: æ‚©ã¿ã‚«ãƒ†ã‚´ãƒª =====
        function stepConcerns() {
            if (!formData.gender) return;
            addMsg(formData.gender, true);
            addMsg('æ°—ã«ãªã£ã¦ã„ã‚‹ã“ã¨ã¯ã‚ã‚Šã¾ã™ã‹ï¼Ÿï¼ˆè¤‡æ•°é¸æŠå¯ï¼‰', false);

            userState = 'concerns';
            setInputArea(`
                <div class="btn-group">
                    <button class="btn-toggle" onclick="toggleConcern(this, 'æ‹æ„›')">ğŸ’• æ‹æ„›</button>
                    <button class="btn-toggle" onclick="toggleConcern(this, 'ä»•äº‹')">ğŸ’¼ ä»•äº‹</button>
                    <button class="btn-toggle" onclick="toggleConcern(this, 'é‡‘é‹')">ğŸ’° é‡‘é‹</button>
                    <button class="btn-toggle" onclick="toggleConcern(this, 'å¥åº·')">ğŸŒ¿ å¥åº·</button>
                    <button class="btn-toggle" onclick="toggleConcern(this, 'äººé–“é–¢ä¿‚')">ğŸ¤ äººé–“é–¢ä¿‚</button>
                    <button class="btn-toggle" onclick="toggleConcern(this, 'ãã®ä»–')">âœ¨ ãã®ä»–</button>
                </div>
                <button class="btn" onclick="nextStep()">æ¬¡ã¸</button>
            `);
        }

        function toggleConcern(el, concern) {
            formData.concerns = formData.concerns || [];
            if (el.classList.contains('active')) {
                el.classList.remove('active');
                formData.concerns = formData.concerns.filter(c => c !== concern);
            } else {
                el.classList.add('active');
                if (!formData.concerns.includes(concern)) {
                    formData.concerns.push(concern);
                }
            }
        }

        // ===== ã‚¹ãƒ†ãƒƒãƒ—: å…·ä½“çš„ãªæ‚©ã¿ =====
        function stepProblem() {
            if (!formData.concerns || formData.concerns.length === 0) {
                addMsg('å°‘ãªãã¨ã‚‚1ã¤é¸ã‚“ã§ãã ã•ã„', false);
                return;
            }
            addMsg(formData.concerns.join('ã€'), true);
            addMsg('å…·ä½“çš„ã«ã©ã‚“ãªã“ã¨ã§ãŠæ‚©ã¿ã§ã™ã‹ï¼Ÿï¼ˆè¨˜è¿°å¼ï¼‰', false);

            userState = 'problem';
            setInputArea(`
                <div class="input-field">
                    <textarea id="problemText" placeholder="ä¾‹ï¼šæœ€è¿‘å½¼ã¨ã®é–¢ä¿‚ãŒã†ã¾ãã„ã‹ãªãã¦..."></textarea>
                </div>
                <button class="btn" onclick="nextStep()">æ¬¡ã¸</button>
            `);
        }

        // ===== ã‚¹ãƒ†ãƒƒãƒ—: ç”Ÿå¹´æœˆæ—¥ =====
        function stepBirth() {
            const problem = document.getElementById('problemText')?.value || '';
            formData.problem = problem;
            addMsg(problem || 'ï¼ˆè¨˜è¿°ãªã—ï¼‰', true);
            addMsg('è¥¿æ´‹å æ˜Ÿè¡“ã«å¿…è¦ãªæƒ…å ±ã‚’ãŠèãã—ã¾ã™ã€‚', false);

            userState = 'birth';
            setInputArea(`
                <div class="input-field">
                    <label>ç”Ÿå¹´æœˆæ—¥ *</label>
                    <input type="date" id="birthDate" required>
                </div>
                <div class="input-field">
                    <label>å‡ºç”Ÿæ™‚é–“</label>
                    <input type="time" id="birthTime">
                </div>
                <div class="input-field">
                    <label>å‡ºç”Ÿåœ°</label>
                    <input type="text" id="birthPlace" placeholder="ä¾‹ï¼šæœ­å¹Œå¸‚">
                </div>
                <button class="btn" onclick="nextStep()">å ã„é–‹å§‹</button>
            `);
        }

        // ===== ã‚¹ãƒ†ãƒƒãƒ—: å ã„å®Ÿè¡Œ =====
        async function executeDiagnose() {
            const date = document.getElementById('birthDate')?.value;
            const time = document.getElementById('birthTime')?.value || '';
            const place = document.getElementById('birthPlace')?.value || '';

            if (!date) {
                addMsg('ç”Ÿå¹´æœˆæ—¥ã¯å¿…é ˆã§ã™', false);
                return;
            }

            formData.birth = { date, time, place };
            addMsg(`${date} (${time || 'æ™‚é–“ä¸æ˜'}) å‡ºç”Ÿåœ°:${place || 'ä¸æ˜'}`, true);

            setInputArea(`
                <div class="loading">
                    <div class="spinner"></div>
                    <p>æ˜Ÿã®é…ç½®ã‚’èª­ã¿è§£ã„ã¦ã„ã¾ã™... ğŸŒŒ</p>
                </div>
            `);

            try {
                const res = await fetch(`${API_BASE}/diagnose`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(formData)
                });

                const json = await res.json();

                if (json.error) {
                    addMsg(`ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${json.error}`, false);
                    clearInputArea();
                    return;
                }

                divinationResult = json.result;
                window.diagnosisId = json.diagnosis_id;

                displayDivinationResult(json.result);

            } catch (err) {
                addMsg('é€šä¿¡ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ', false);
                clearInputArea();
            }
        }

        // ===== å ã„çµæœè¡¨ç¤ºï¼ˆæ–‡å­—æ•°2å€ï¼‰ =====
        function displayDivinationResult(result) {
            clearInputArea();

            // é‹å‘½ã®åœ°å›³
            if (result.destiny_map) {
                const section = document.createElement('div');
                section.className = 'result-section';
                section.innerHTML = `<h3>ã€é‹å‘½ã®åœ°å›³ã€‘</h3><p>${result.destiny_map}</p>`;
                document.getElementById('chatBox').appendChild(section);
            }

            if (result.past) {
                const section = document.createElement('div');
                section.className = 'result-section';
                section.innerHTML = `<h3>ã€éå»ã€‘</h3><p>${result.past}</p>`;
                document.getElementById('chatBox').appendChild(section);
            }

            if (result.present) {
                const section = document.createElement('div');
                section.className = 'result-section';
                section.innerHTML = `<h3>ã€ç¾åœ¨ã€‘</h3><p>${result.present}</p>`;
                document.getElementById('chatBox').appendChild(section);
            }

            if (result.future) {
                const section = document.createElement('div');
                section.className = 'result-section';
                section.innerHTML = `<h3>ã€æœªæ¥ã€‘</h3><p>${result.future}</p>`;
                document.getElementById('chatBox').appendChild(section);
            }

            if (result.element_diagnosis) {
                const section = document.createElement('div');
                section.className = 'result-section';
                section.innerHTML = `<h3>ã€ã‚¨ãƒ¬ãƒ¡ãƒ³ãƒˆè¨ºæ–­ã€‘</h3><p>${result.element_diagnosis}</p>`;
                document.getElementById('chatBox').appendChild(section);
            }

            // ã‚ªãƒ©ã‚¯ãƒ«ã‚«ãƒ¼ãƒ‰
            if (result.oracle_card) {
                const section = document.createElement('div');
                section.className = 'result-section';
                let html = `<h3>ã€ã‚ªãƒ©ã‚¯ãƒ«ã‚«ãƒ¼ãƒ‰ã€‘</h3><p>${result.oracle_card.name}</p>`;
                if (result.oracle_card.image_url) {
                    const transform = result.oracle_card.is_upright ? '' : 'transform: scaleY(-1);';
                    html += `<img src="${result.oracle_card.image_url}" class="result-image" style="${transform}" onerror="this.style.display='none'">`;
                }
                html += `<p>${result.oracle_message || result.oracle_card.meaning}</p>`;
                section.innerHTML = html;
                document.getElementById('chatBox').appendChild(section);
            }

            // çŸ³å€™è£œè¡¨ç¤º
            if (result.stones_for_user && result.stones_for_user.length > 0) {
                const section = document.createElement('div');
                section.className = 'result-section';
                let html = `<h3>ğŸ’ ã‚ãªãŸã«ãƒãƒƒãƒã™ã‚‹çŸ³ã¯ã“ã‚Œã§ã™</h3>`;
                
                if (result.stones_image_url) {
                    html += `<img src="${result.stones_image_url}" class="result-image" onerror="this.style.display='none'">`;
                }
                
                result.stones_for_user.forEach(stone => {
                    html += `
                        <div class="stone-item">
                            <div class="name">ğŸ’ ${stone.name}</div>
                            <div class="reason">${stone.reason}</div>
                        </div>
                    `;
                });
                
                section.innerHTML = html;
                document.getElementById('chatBox').appendChild(section);
            }

            // ãƒ–ãƒ¬ã‚¹ãƒ¬ãƒƒãƒˆææ¡ˆæ–‡
            if (result.bracelet_proposal) {
                const section = document.createElement('div');
                section.className = 'result-section';
                section.innerHTML = `<h3>ã€çŸ³ã®ææ¡ˆã€‘</h3><p>${result.bracelet_proposal}</p>`;
                document.getElementById('chatBox').appendChild(section);
            }

            document.getElementById('chatBox').scrollTop = document.getElementById('chatBox').scrollHeight;

            setInputArea(`
                <button class="btn" onclick="stepBraceletSize()">ğŸ’ ãƒ–ãƒ¬ã‚¹ãƒ¬ãƒƒãƒˆè¨­å®šã¸é€²ã‚€</button>
                <button class="btn btn-secondary" onclick="location.reload()">ğŸ”„ ã‚‚ã†ä¸€åº¦å ã†</button>
            `);
        }

        // ===== ã‚¹ãƒ†ãƒƒãƒ—: ãƒ–ãƒ¬ã‚¹ãƒ¬ãƒƒãƒˆã‚µã‚¤ã‚ºï¼‹ãƒ‡ã‚¶ã‚¤ãƒ³é¸æŠ =====
        function stepBraceletSize() {
            addMsg('ãƒ–ãƒ¬ã‚¹ãƒ¬ãƒƒãƒˆã®ã‚µã‚¤ã‚ºã¨ãƒ‡ã‚¶ã‚¤ãƒ³ã‚’é¸ã‚“ã§ãã ã•ã„ã€‚', false);

            setInputArea(`
                <div class="input-field">
                    <label>æ‰‹é¦–ã®å†…å¾„ï¼ˆcmï¼‰</label>
                    <input type="number" id="wristInner" step="0.5" value="15.0" min="10" max="25">
                    <small style="color:#999;">æ‰‹é¦–ã®æœ€ã‚‚ç´°ã„éƒ¨åˆ†ã‚’æ¸¬ã£ã¦ãã ã•ã„</small>
                </div>
                <div class="input-field">
                    <label>çŸ³ã®å¤§ãã•ï¼ˆmmï¼‰</label>
                    <select id="beadSize">
                        <option value="6">6mmï¼ˆç´°ã‚ã§è¯å¥¢ï¼‰</option>
                        <option value="8" selected>8mmï¼ˆæ¨™æº–ï¼‰</option>
                        <option value="10">10mmï¼ˆå¤ªã‚ã§å­˜åœ¨æ„Ÿï¼‰</option>
                        <option value="12">12mmï¼ˆãƒœãƒªãƒ¥ãƒ¼ãƒ é‡è¦–ï¼‰</option>
                    </select>
                </div>
                <div class="input-field">
                    <label>ãƒ‡ã‚¶ã‚¤ãƒ³ã‚¹ã‚¿ã‚¤ãƒ«</label>
                    <div class="btn-group">
                        <button class="btn-toggle active" onclick="selectDesign('ãŠã¾ã‹ã›', this)">ãŠã¾ã‹ã›</button>
                        <button class="btn-toggle" onclick="selectDesign('å˜è‰²ï¼ˆã‚·ãƒ³ãƒ—ãƒ«ï¼‰', this)">å˜è‰²</button>
                        <button class="btn-toggle" onclick="selectDesign('ï¼’è‰²ï¼ˆæ··åˆï¼‰', this)">ï¼’è‰²</button>
                        <button class="btn-toggle" onclick="selectDesign('ãƒˆãƒƒãƒ—ã‚’å…¥ã‚Œã‚‹', this)">ãƒˆãƒƒãƒ—</button>
                    </div>
                </div>
                <button class="btn" onclick="buildBracelet()">âœ¨ ã‚ãªãŸã‚’å°ããƒ–ãƒ¬ã‚¹ãƒ¬ãƒƒãƒˆã‚’å®Œæˆã•ã›ã‚‹</button>
            `);
        }

        function selectDesign(style, el) {
            formData.design_style = style;
            document.querySelectorAll('.input-field:last-child .btn-toggle').forEach(b => b.classList.remove('active'));
            el.classList.add('active');
        }

        // ===== ãƒ–ãƒ¬ã‚¹ãƒ¬ãƒƒãƒˆå®Œæˆ =====
        async function buildBracelet() {
            const wrist = parseFloat(document.getElementById('wristInner')?.value || 15.0);
            const beadSize = parseInt(document.getElementById('beadSize')?.value || 8);
            const designStyle = formData.design_style || 'ãŠã¾ã‹ã›';

            addMsg(`æ‰‹é¦–å†…å¾„: ${wrist}cm / çŸ³ã‚µã‚¤ã‚º: ${beadSize}mm / ãƒ‡ã‚¶ã‚¤ãƒ³: ${designStyle}`, true);

            setInputArea(`
                <div class="loading">
                    <div class="spinner"></div>
                    <p>ãƒ–ãƒ¬ã‚¹ãƒ¬ãƒƒãƒˆã‚’ãƒ‡ã‚¶ã‚¤ãƒ³ã—ã¦ã„ã¾ã™... ğŸ’</p>
                </div>
            `);

            try {
                const res = await fetch(`${API_BASE}/build-bracelet`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        diagnosis_id: window.diagnosisId,
                        stones_for_user: divinationResult.stones_for_user || [],
                        wrist_inner_cm: wrist,
                        bead_size_mm: beadSize,
                        design_style: designStyle
                    })
                });

                const json = await res.json();

                if (json.error) {
                    addMsg(`ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${json.error}`, false);
                    clearInputArea();
                    return;
                }

                displayBraceletResult(json);

            } catch (err) {
                addMsg('é€šä¿¡ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ', false);
                clearInputArea();
            }
        }

        // ===== ãƒ–ãƒ¬ã‚¹ãƒ¬ãƒƒãƒˆçµæœè¡¨ç¤ºï¼ˆ3æ®µè½ï¼‹å°è¦‹å‡ºã—ï¼‰ =====
        function displayBraceletResult(data) {
            clearInputArea();

            const section = document.createElement('div');
            section.className = 'result-section';
            let html = `<h3>ğŸ’ ã‚ãªãŸã‚’å°ããƒ–ãƒ¬ã‚¹ãƒ¬ãƒƒãƒˆã¯ã“ã‚Œã§ã™</h3>`;
            
            if (divinationResult.stones_image_url) {
                html += `<img src="${divinationResult.stones_image_url}" class="result-image" onerror="this.style.display='none'">`;
            }
            
            html += `<p>${data.design_text || 'ãƒ‡ã‚¶ã‚¤ãƒ³æƒ…å ±ãŒã‚ã‚Šã¾ã›ã‚“'}</p>`;
            
            section.innerHTML = html;
            document.getElementById('chatBox').appendChild(section);

            // ã‚ªãƒ¼ãƒ€ãƒ¼æƒ…å ±
            if (data.order_summary) {
                const orderSection = document.createElement('div');
                orderSection.className = 'result-section';
                orderSection.innerHTML = `<h3>ğŸ“‹ ã‚ãªãŸã‚’å°ãçŸ³ãŸã¡</h3><p style="font-size:13px;">${data.order_summary.replace(/\n/g, '<br>')}</p>`;
                document.getElementById('chatBox').appendChild(orderSection);
            }

            document.getElementById('chatBox').scrollTop = document.getElementById('chatBox').scrollHeight;

            setInputArea(`
                <button class="btn" onclick="confirmOrder()">ğŸ“± LINEã§ã‚ªãƒ¼ãƒ€ãƒ¼ã™ã‚‹</button>
                <button class="btn btn-secondary" onclick="location.reload()">ğŸ”„ æœ€åˆã‹ã‚‰å§‹ã‚ã‚‹</button>
            `);
        }

        // ===== ã‚ªãƒ¼ãƒ€ãƒ¼ç¢ºèª =====
        function confirmOrder() {
            addMsg('ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ï¼ã‚ªãƒ¼ãƒ€ãƒ¼æƒ…å ±ã‚’é€ä¿¡ã—ã¾ã—ãŸã€‚', false);
            clearInputArea();
            addMsg('ãƒ¡ãƒ¼ãƒ«ã§ç¢ºèªãŒæ¥ã¾ã™ã€‚ãŠå¾…ã¡ãã ã•ã„ âœ¨', false);
        }

        // ===== ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ =====
        function nextStep() {
            if (userState === 'gender') stepConcerns();
            else if (userState === 'concerns') stepProblem();
            else if (userState === 'problem') stepBirth();
            else if (userState === 'birth') executeDiagnose();
        }

        // åˆæœŸè¡¨ç¤º
        window.onload = function() {
            stepGender();
        };
    </script>
</body>
</html>