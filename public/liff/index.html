<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>ãƒ–ãƒ¬ã‚¹è¨ºæ–­</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; background-color: #8da1b9; margin: 0; padding: 0; display: flex; flex-direction: column; height: 100vh; }
    #chat-container { flex: 1; overflow-y: auto; padding: 15px; padding-bottom: 80px; }
    .message { margin-bottom: 15px; clear: both; max-width: 80%; }
    .bot-msg { float: left; }
    .bot-bubble { background-color: #fff; color: #333; padding: 10px 14px; border-radius: 14px; border-top-left-radius: 2px; box-shadow: 0 1px 1px rgba(0,0,0,0.1); font-size: 15px; line-height: 1.4; white-space: pre-wrap; }
    .user-msg { float: right; }
    .user-bubble { background-color: #92e3a9; color: #333; padding: 10px 14px; border-radius: 14px; border-top-right-radius: 2px; box-shadow: 0 1px 1px rgba(0,0,0,0.1); font-size: 15px; line-height: 1.4; }
    #input-area { position: fixed; bottom: 0; left: 0; width: 100%; background-color: #fff; padding: 10px; box-shadow: 0 -2px 5px rgba(0,0,0,0.05); display: flex; gap: 10px; box-sizing: border-box; }
    #text-input { flex: 1; padding: 10px; border: 1px solid #ddd; border-radius: 20px; font-size: 16px; outline: none; }
    #send-btn { background-color: #06c755; color: white; border: none; padding: 0 20px; border-radius: 20px; font-weight: bold; cursor: pointer; }
    #options-area { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 5px; }
    .option-btn { background-color: #fff; border: 1px solid #06c755; color: #06c755; padding: 8px 16px; border-radius: 20px; font-size: 14px; cursor: pointer; }
    .option-btn:active { background-color: #06c755; color: white; }

    /* çµæœç”»é¢ */
    #result-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(255,255,255,0.98); z-index: 100; display: none; overflow-y: auto; padding: 20px; box-sizing: border-box; }
    .result-content { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); border: 1px solid #eee; }
    h2 { color: #333; text-align: center; }
    #reading-text { white-space: pre-wrap; line-height: 1.8; background-color: #f9f9f9; padding: 15px; border-radius: 8px; margin-bottom: 20px; }
    .order-button { display: block; width: 100%; padding: 15px; background-color: #06c755; color: white; text-align: center; border: none; border-radius: 8px; font-size: 18px; font-weight: bold; margin-top: 20px; cursor: pointer; }

    /* ç”»åƒã‚¹ã‚¿ã‚¤ãƒ« */
    .card-container { text-align: center; margin-bottom: 20px; perspective: 1000px; }
    .card-img { width: 160px; height: auto; border-radius: 10px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); transition: transform 0.6s; }
    /* é€†ä½ç½®ç”¨ã®ã‚¯ãƒ©ã‚¹ */
    .reversed { transform: rotate(180deg); }

    .bracelet-img { width: 100%; height: auto; border-radius: 8px; margin-bottom: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }

    .card-label { 
        margin-top: 10px; font-weight: bold; font-size: 18px; color: #444; 
        display: flex; align-items: center; justify-content: center; gap: 8px;
    }
    .position-badge {
        font-size: 12px; padding: 2px 8px; border-radius: 10px; color: white;
    }
    .badge-up { background-color: #06c755; }   /* æ­£ä½ç½®ï¼šç·‘ */
    .badge-rev { background-color: #d64040; }  /* é€†ä½ç½®ï¼šèµ¤ */
  </style>
</head>
<body>

  <div id="chat-container">
    <div class="message bot-msg">
      <div class="bot-bubble">
        ã“ã‚“ã«ã¡ã¯âœ¨<br>
        ã‚ãªãŸã«ã´ã£ãŸã‚Šã®ãƒ–ãƒ¬ã‚¹ãƒ¬ãƒƒãƒˆã‚’ä½œã‚‹ãŸã‚ã«ã€ã„ãã¤ã‹è³ªå•ã•ã›ã¦ãã ã•ã„ã€‚<br>
        ã¾ãšã¯æ€§åˆ¥ã‚’æ•™ãˆã¦ãã ã•ã„ã€‚
        <div id="gender-options" style="margin-top:10px; display:flex; gap:5px;">
          <button class="option-btn" onclick="selectGender('female')">å¥³æ€§</button>
          <button class="option-btn" onclick="selectGender('male')">ç”·æ€§</button>
          <button class="option-btn" onclick="selectGender('other')">ãã®ä»–</button>
        </div>
      </div>
    </div>
  </div>

  <div id="input-area" style="display:none;">
    <input type="text" id="text-input" placeholder="å…¥åŠ›ã—ã¦ãã ã•ã„...">
    <button id="send-btn" onclick="handleSend()">é€ä¿¡</button>
  </div>

  <!-- æ‚©ã¿ã‚«ãƒ†ã‚´ãƒªé¸æŠ -->
  <div id="problem-category-options" style="display:none; flex-wrap:wrap; gap:5px; margin-top:5px;">
      <button class="option-btn" onclick="selectProblemCategory('æ‹æ„›')">æ‹æ„›</button>
      <button class="option-btn" onclick="selectProblemCategory('ä»•äº‹')">ä»•äº‹</button>
      <button class="option-btn" onclick="selectProblemCategory('äººé–“é–¢ä¿‚')">äººé–“é–¢ä¿‚</button>
      <button class="option-btn" onclick="selectProblemCategory('é‡‘é‹')">é‡‘é‹</button>
      <button class="option-btn" onclick="selectProblemCategory('å¥åº·')">å¥åº·</button>
      <button class="option-btn" onclick="selectProblemCategory('ãã®ä»–')">ãã®ä»–</button>
  </div>

  <!-- çµæœè¡¨ç¤º -->
  <div id="result-overlay">
    <div class="result-content">
      <h2>ğŸ”® é‘‘å®šçµæœ ğŸ”®</h2>

      <!-- ã‚ªãƒ©ã‚¯ãƒ«ã‚«ãƒ¼ãƒ‰è¡¨ç¤ºã‚¨ãƒªã‚¢ -->
      <div class="card-container">
        <p style="font-size:12px; color:#666; margin-bottom:5px;">ã‚ãªãŸã¸ã®ã‚ªãƒ©ã‚¯ãƒ«ã‚«ãƒ¼ãƒ‰</p>
        <img id="card-image" class="card-img" src="" alt="Oracle Card">
        <div class="card-label">
            <span id="card-name"></span>
            <span id="position-badge" class="position-badge"></span>
        </div>
        <p id="card-meaning" style="font-size:14px; color:#666; margin-top:5px;"></p>
      </div>

      <div id="reading-text"></div>

      <h3>ğŸ’ ã‚ãªãŸã®ãŠå®ˆã‚Šãƒ–ãƒ¬ã‚¹</h3>
      <img id="bracelet-image" class="bracelet-img" src="" alt="Bracelet Image">
      <p id="design-concept" style="font-weight:bold; color:#555; text-align:center;"></p>
      <ul id="stones-list"></ul>

      <button id="order-btn" class="order-button">LINEã§ã‚ªãƒ¼ãƒ€ãƒ¼ã™ã‚‹</button>
      <div style="text-align:center; margin-top:10px;">
        <small id="diagnosis-id-disp" style="color:#aaa;"></small>
      </div>
    </div>
  </div>

  <script>
    const answers = {
      gender: "", birth_date: "", birth_time: "12:00", birth_place: "æ—¥æœ¬",
      problem_category: "", problem_detail: ""
    };
    let currentStep = 0; 

    const YOUR_LIFF_ID = "YOUR_LIFF_ID"; // â˜…LIFF IDã‚’è¨­å®š
    liff.init({ liffId: YOUR_LIFF_ID }).catch(err => console.error(err));

    function addMessage(text, isUser = false, optionsHtml = null) {
      const container = document.getElementById("chat-container");
      const div = document.createElement("div");
      div.className = isUser ? "message user-msg" : "message bot-msg";
      div.innerHTML = `<div class="${isUser ? 'user-bubble' : 'bot-bubble'}">${text}${optionsHtml ? optionsHtml : ''}</div>`;
      container.appendChild(div);
      container.scrollTop = container.scrollHeight;
    }

    function selectGender(gender) {
      answers.gender = gender;
      document.getElementById("gender-options").style.display = "none";
      addMessage(gender === 'female' ? 'å¥³æ€§' : (gender === 'male' ? 'ç”·æ€§' : 'ãã®ä»–'), true);
      setTimeout(() => {
        addMessage("ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ã€‚<br>æ¬¡ã«ã€ç”Ÿå¹´æœˆæ—¥ã‚’æ•™ãˆã¦ãã ã•ã„ã€‚ï¼ˆä¾‹ï¼š1995-03-21ï¼‰");
        document.getElementById("text-input").type = "date";
        document.getElementById("input-area").style.display = "flex";
        currentStep = 1;
      }, 500);
    }

    function selectProblemCategory(category) {
        answers.problem_category = category;
        addMessage(category, true);
        setTimeout(() => {
            addMessage("è©³ã—ãæ•™ãˆã¦ã„ãŸã ã‘ã¾ã™ã‹ï¼Ÿ<br>ï¼ˆè‡ªç”±ã«å…¥åŠ›ã—ã¦ãã ã•ã„ï¼‰");
            document.getElementById("input-area").style.display = "flex";
            document.getElementById("text-input").focus();
            currentStep = 5;
        }, 500);
    }

    function handleSend() {
      const input = document.getElementById("text-input");
      const val = input.value;
      if (!val) return;
      addMessage(val, true);
      input.value = "";

      if (currentStep === 1) { // ç”Ÿå¹´æœˆæ—¥
        answers.birth_date = val;
        setTimeout(() => {
          addMessage("ç”Ÿã¾ã‚ŒãŸæ™‚é–“ã¯ã‚ã‹ã‚Šã¾ã™ã‹ï¼Ÿ<br>ï¼ˆä¸æ˜ãªå ´åˆã¯ãã®ã¾ã¾é€ä¿¡ï¼‰");
          input.type = "time";
          currentStep = 2;
        }, 500);
      } else if (currentStep === 2) { // æ™‚é–“
        if (val) answers.birth_time = val;
        setTimeout(() => {
          addMessage("ç”Ÿã¾ã‚ŒãŸå ´æ‰€ï¼ˆéƒ½é“åºœçœŒï¼‰ã¯ã©ã“ã§ã™ã‹ï¼Ÿ<br>ï¼ˆä¸æ˜ãªå ´åˆã¯ãã®ã¾ã¾é€ä¿¡ï¼‰");
          input.type = "text";
          currentStep = 3;
        }, 500);
      } else if (currentStep === 3) { // å ´æ‰€
        if (val) answers.birth_place = val;
        setTimeout(() => {
          const optionsHtml = document.getElementById("problem-category-options").outerHTML.replace("display:none", "display:flex");
          addMessage("ã©ã®ã‚ˆã†ãªã“ã¨ã«ã¤ã„ã¦å ã„ã¾ã™ã‹ï¼Ÿ", false, optionsHtml);
          document.getElementById("input-area").style.display = "none";
          currentStep = 4;
        }, 500);
      } else if (currentStep === 5) { // æ‚©ã¿è©³ç´°
        answers.problem_detail = val;
        document.getElementById("input-area").style.display = "none";
        startDiagnosis();
      }
    }

    async function startDiagnosis() {
      addMessage("ã‚ªãƒ©ã‚¯ãƒ«ã‚«ãƒ¼ãƒ‰ã‚’å¼•ã„ã¦ã€æ˜Ÿã‚’èª­ã¿è§£ã„ã¦ã„ã¾ã™...ğŸ”®<br>ã—ã°ã‚‰ããŠå¾…ã¡ãã ã•ã„...");

      const combinedProblem = `ã€ã‚«ãƒ†ã‚´ãƒªã€‘${answers.problem_category}
ã€è©³ç´°ã€‘${answers.problem_detail}`;

      const payload = {
        gender: answers.gender,
        problem: combinedProblem,
        birth: { date: answers.birth_date, time: answers.birth_time, place: answers.birth_place },
        design_pref: "ãŠã¾ã‹ã›"
      };

      try {
        const res = await fetch("/api/diagnose", {
          method: "POST", headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });

        if (!res.ok) throw new Error("API Error");
        const data = await res.json();
        const r = data.result;
        const o = data.order_summary;

        // --- ã‚ªãƒ©ã‚¯ãƒ«ã‚«ãƒ¼ãƒ‰è¡¨ç¤ºå‡¦ç† ---
        if (r.oracle_card) {
          const img = document.getElementById("card-image");
          img.src = r.oracle_card.image_url;

          // é€†ä½ç½®ãªã‚‰ç”»åƒã‚’180åº¦å›è»¢
          if (!r.oracle_card.is_upright) {
            img.classList.add("reversed");
            document.getElementById("position-badge").innerText = "é€†ä½ç½®";
            document.getElementById("position-badge").className = "position-badge badge-rev";
          } else {
            img.classList.remove("reversed");
            document.getElementById("position-badge").innerText = "æ­£ä½ç½®";
            document.getElementById("position-badge").className = "position-badge badge-up";
          }

          document.getElementById("card-name").innerText = r.oracle_card.name;
          document.getElementById("card-meaning").innerText = r.oracle_card.meaning;
        }

        // ãƒ–ãƒ¬ã‚¹ãƒ¬ãƒƒãƒˆç”»åƒ
        if (r.bracelet_image_url) {
          document.getElementById("bracelet-image").src = r.bracelet_image_url;
        }

        document.getElementById("reading-text").innerText = r.reading;
        document.getElementById("design-concept").innerText = r.design_concept;
        document.getElementById("diagnosis-id-disp").innerText = "ID: " + data.diagnosis_id;

        const list = document.getElementById("stones-list");
        list.innerHTML = "";
        r.stones.forEach(s => {
          const li = document.createElement("li");
          li.innerText = `${s.name} - ${s.reason}`;
          list.appendChild(li);
        });

        document.getElementById("order-btn").onclick = function() {
           if (!liff.isInClient()) {
             alert("ã“ã®æ©Ÿèƒ½ã¯LINEã‚¢ãƒ—ãƒªå†…ã§ã®ã¿å‹•ä½œã—ã¾ã™ã€‚");
             return;
           }
           liff.sendMessages([{
             type: 'text',
             text: `ã€ã‚ªãƒ¼ãƒ€ãƒ¼å¸Œæœ›ã€‘
è¨ºæ–­ID: ${data.diagnosis_id}

[å†…å®¹]
${o.order_line}

[æ‚©ã¿]
${combinedProblem}

[ã‚ªãƒ©ã‚¯ãƒ«çµæœ]
${r.oracle_card.name} (${r.oracle_card.is_upright ? 'æ­£' : 'é€†'})`
           }]).then(() => liff.closeWindow())
           .catch(err => alert("é€ä¿¡ã‚¨ãƒ©ãƒ¼: " + err));
        };

        setTimeout(() => {
          document.getElementById("result-overlay").style.display = "block";
        }, 1000);

      } catch (err) {
        addMessage("ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: " + err.message);
      }
    }
  </script>
</body>
</html>