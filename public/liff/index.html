<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ãƒ‘ãƒ¯ãƒ¼ã‚¹ãƒˆãƒ¼ãƒ³è¨ºæ–­</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <style>
    body { font-family: sans-serif; padding: 20px; background-color: #f9f9f9; }
    h1 { color: #333; text-align: center; }
    .form-group { margin-bottom: 15px; }
    label { display: block; margin-bottom: 5px; font-weight: bold; }
    input, select, textarea { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box; }
    button { width: 100%; padding: 12px; background-color: #06c755; color: white; border: none; border-radius: 4px; font-size: 16px; cursor: pointer; }
    button:hover { background-color: #05b34c; }
    #result-area { margin-top: 20px; display: none; background: white; padding: 15px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
    .loading { text-align: center; color: #666; display: none; }
  </style>
</head>
<body>
  <h1>âœ¨ã‚ãªãŸã ã‘ã®ãƒ–ãƒ¬ã‚¹è¨ºæ–­âœ¨</h1>

  <form id="diagnosis-form">
    <div class="form-group">
      <label>ä»Šã®ãŠæ‚©ã¿ã¯ï¼Ÿ</label>
      <select name="problem" required>
        <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
        <option value="æ‹æ„›">æ‹æ„›ãƒ»å‡ºä¼šã„</option>
        <option value="ä»•äº‹">ä»•äº‹ãƒ»ã‚­ãƒ£ãƒªã‚¢</option>
        <option value="äººé–“é–¢ä¿‚">äººé–“é–¢ä¿‚ãƒ»å®¶æ—</option>
        <option value="é‡‘é‹">é‡‘é‹ãƒ»è²¡é‹</option>
        <option value="å¥åº·">å¥åº·ãƒ»ãƒ¡ãƒ³ã‚¿ãƒ«</option>
      </select>
    </div>

    <div class="form-group">
      <label>ãƒ‡ã‚¶ã‚¤ãƒ³ã®å¸Œæœ›</label>
      <select name="design_pref">
        <option value="simple">ã‚·ãƒ³ãƒ—ãƒ«ï¼ˆæ—¥å¸¸ä½¿ã„ï¼‰</option>
        <option value="top">ãƒˆãƒƒãƒ—ã«ã‚¢ã‚¯ã‚»ãƒ³ãƒˆï¼ˆçŸ³ã‚’å¼·èª¿ï¼‰</option>
        <option value="colorful">ã‚«ãƒ©ãƒ•ãƒ«ï¼ˆè¯ã‚„ã‹ã«ï¼‰</option>
        <option value="pro">ãŠã¾ã‹ã›</option>
      </select>
    </div>

    <div class="form-group">
      <label>ç”Ÿå¹´æœˆæ—¥</label>
      <input type="date" name="birth_date" required>
    </div>

    <div class="form-group">
      <label>å‡ºç”Ÿæ™‚é–“ï¼ˆä¸æ˜ãªå ´åˆã¯12:00ï¼‰</label>
      <input type="time" name="birth_time" value="12:00">
    </div>

    <div class="form-group">
      <label>å‡ºç”Ÿåœ°ï¼ˆå¸‚åŒºç”ºæ‘ï¼‰</label>
      <input type="text" name="birth_place" placeholder="ä¾‹ï¼šæ±äº¬éƒ½æ–°å®¿åŒº" required>
    </div>

    <div class="form-group">
      <label>æ‰‹é¦–ã‚µã‚¤ã‚º (cm)</label>
      <input type="number" name="wrist_inner_cm" value="15.0" step="0.5">
    </div>

    <button type="submit">AIã§å ã†ğŸ”®</button>
  </form>

  <div id="loading" class="loading">
    <p>æ˜Ÿã‚’èª­ã¿è§£ã„ã¦ã„ã¾ã™...<br>ã—ã°ã‚‰ããŠå¾…ã¡ãã ã•ã„...</p>
  </div>

  <div id="result-area">
    <h2>é‘‘å®šçµæœ</h2>
    <div id="reading-text"></div>

    <h3>ã”ææ¡ˆã™ã‚‹ãƒ–ãƒ¬ã‚¹ãƒ¬ãƒƒãƒˆ</h3>
    <p id="design-concept" style="font-weight:bold; color:#555;"></p>
    <ul id="stones-list"></ul>

    <div style="margin-top:20px; padding-top:10px; border-top:1px dashed #ccc;">
      <p style="font-size:0.9em; color:#666;">ã‚ªãƒ¼ãƒ€ãƒ¼å†…å®¹:</p>
      <p id="order-line" style="font-weight:bold;"></p>
    </div>

    <button id="order-btn" style="margin-top:15px; background-color:#333;">LINEã§ã‚ªãƒ¼ãƒ€ãƒ¼ã™ã‚‹</button>
  </div>

  <script>
    async function main() {
      // Initialize LIFF
      // Replace with your actual LIFF ID
      const MY_LIFF_ID = "2009078638-GZhFVgaz"; 

      try {
        await liff.init({ liffId: MY_LIFF_ID });
      } catch (err) {
        console.error("LIFF Init failed", err);
      }

      const form = document.getElementById("diagnosis-form");
      const loading = document.getElementById("loading");
      const resultArea = document.getElementById("result-area");

      form.addEventListener("submit", async (e) => {
        e.preventDefault();

        // UI Update
        form.style.display = "none";
        loading.style.display = "block";

        const fd = new FormData(form);

        // Build JSON payload
        const payload = {
          problem: fd.get("problem"),
          design_pref: fd.get("design_pref"),
          birth: {
            date: fd.get("birth_date"),
            time: fd.get("birth_time"),
            place: fd.get("birth_place"),
          },
          wrist_inner_cm: fd.get("wrist_inner_cm"),
          // Get LINE User ID if logged in
          line_user_id: liff.isLoggedIn() ? (await liff.getProfile()).userId : null
        };

        try {
          // Call Vercel API
          const res = await fetch("/api/diagnose", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload),
          });

          if (!res.ok) throw new Error("API Request failed");

          const data = await res.json();
          const r = data.result;
          const o = data.order_summary;

          // Render Results
          document.getElementById("reading-text").innerText = r.reading;
          document.getElementById("design-concept").innerText = r.design_concept;

          const list = document.getElementById("stones-list");
          list.innerHTML = "";
          r.stones.forEach(s => {
            const li = document.createElement("li");
            li.innerText = `${s.name} (${s.count}å€‹) - ${s.reason}`;
            list.appendChild(li);
          });

          document.getElementById("order-line").innerText = o.order_line;

          loading.style.display = "none";
          resultArea.style.display = "block";

          // Handle "Order" button -> Send message to LINE talk
          document.getElementById("order-btn").onclick = function() {
             if (liff.isInClient()) {
               liff.sendMessages([{
                 type: 'text',
                 text: `ã€ã‚ªãƒ¼ãƒ€ãƒ¼å¸Œæœ›ã€‘
ä»¥ä¸‹ã®å†…å®¹ã§ãŠé¡˜ã„ã—ã¾ã™ï¼

${o.order_line}

è¨ºæ–­ID: ${data.diagnosis_id}`
               }]).then(() => {
                 liff.closeWindow();
               }).catch(err => {
                 alert("ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸ");
               });
             } else {
               alert("ã“ã®æ©Ÿèƒ½ã¯LINEã‚¢ãƒ—ãƒªå†…ã§ã®ã¿å‹•ä½œã—ã¾ã™");
             }
          };

        } catch (err) {
          loading.style.display = "none";
          form.style.display = "block";
          alert("ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: " + err.message);
        }
      });
    }
    main();
  </script>
</body>
</html>
